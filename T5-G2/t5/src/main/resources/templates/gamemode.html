<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GameMode</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/t5/css/Css/gamemode.css"/>

 
</head>

<body>

  <div class="container mt-5">
    <!-- Header con username e bottone logout -->
    <div class="row mb-4 align-items-center">
      <div class="col text-start">
        <p class="user_position_main" style="color: white;">Username: <span id="usernameField"></span></p>
      </div>
      <div class="col-auto">
        <button id="logoutButton" type="button" class="btn btn-custom btn-sm" onclick="redirectToMain()">Go Back</button>
      </div>
    </div>

    <!-- Titolo modalità selezionata -->
    <div class="text-center mb-4">
      <h3 id="selectedMode" class="text-custom">Modalità Selezionata:</h3>
    </div>

    <!-- Form di selezione -->
    <div class="card col-md-6 mx-auto">
      <h2 class="text-center text-custom mb-4">Seleziona un'opzione</h2>
      <form>
        <!-- Selezione Classe UT -->
        <div class="form-group mb-3">
          <label for="select_class">Seleziona la Classe UT:</label>
          <select class="form-control" id="select_class">
            <option value="">Seleziona un'opzione</option>
            <th:block th:each="option : ${lista_classi}">
              <option th:value="${option.name}" th:text="${option.name}"></option>
            </th:block>
          </select>
        </div>

        <!-- Selezione Robot -->
        <div class="form-group mb-3">
          <label for="select_robot">Seleziona il Robot:</label>
          <select class="form-control" id="select_robot">
            <option value="">Seleziona un'opzione</option>
            <th:block th:each="option : ${lista_robot}">
              <option th:value="${option}" th:text="${option}"></option>
            </th:block>
          </select>
        </div>

        <!-- Selezione Difficoltà -->
        <div class="form-group mb-3">
          <label for="select_diff">Seleziona la difficoltà:</label>
          <select class="form-control" id="select_diff">
            <option value="">Seleziona un'opzione</option>
            <option value="1">Easy</option>
            <option value="2">Medium</option>
            <option value="3">Hard</option>
          </select>
        </div>

        <!-- Link editor -->
        <div class="text-center pt-2">
          <a id="link_editor" class="btn btn-primary" href="#" role="button">Vai all'editor</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Inclusione jQuery -->
  <script th:src="@{/t5/jquery/jquery-3.7.0.com.js}" th:inline="javascript"></script>

  <script>
    // Funzione per ottenere i parametri dall'URL
    function getParameterByName(name) {
      const url = window.location.href;
      name = name.replace(/[\[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      const results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    // Funzione per aggiornare la modalità selezionata
    function updateModeFromUrl() {
      const mode = getParameterByName('mode');
      if (mode) {
        const sanitizedMode = mode.replace(/[^a-zA-Z0-9\s]/g, ' ');
        document.getElementById('selectedMode').textContent += ' ' + sanitizedMode;
        localStorage.setItem('modalita', sanitizedMode);
      }
    }

    // Funzione per salvare i valori nel localStorage
    function saveToLocalStorage() {
      const selectClassValue = document.getElementById('select_class').value;
      const selectRobotValue = document.getElementById('select_robot').value;
      const selectDifficultyValue = document.getElementById('select_diff').value;

      // Salva i valori nel localStorage
      localStorage.setItem('underTestClassName', selectClassValue);
      localStorage.setItem('robot', selectRobotValue);
      localStorage.setItem('difficulty', selectDifficultyValue);

      // Aggiorna il link
      const link = document.getElementById("link_editor");
      link.setAttribute("href", "/editor?ClassUT=" + selectClassValue);
    }

    // Event listeners per i dropdown
    document.getElementById('select_class').addEventListener('change', saveToLocalStorage);
    document.getElementById('select_robot').addEventListener('change', saveToLocalStorage);
    document.getElementById('select_diff').addEventListener('change', saveToLocalStorage);

    // Esegui all'avvio
    window.onload = updateModeFromUrl;

    function redirectToMain() {
      window.location.href = "/main";
    }
    
const getCookie = (name) => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
    return null;
};
 
const parseJwt = (token) => {
    try {
        return JSON.parse(atob(token.split(".")[1]));
    } catch (e) {
        return null;
    }
};

    const jwtData = parseJwt(getCookie("jwt"));
    const username = jwtData.sub;
    const userId = jwtData.userId;
    document.getElementById('usernameField').textContent = username;
  </script>

</body>

</html>

